{% extends 'core/base.html' %}
{% block style %}
<style>
    #map {
        width: 85%;
        min-height: 650px;
        margin: 20px;
    }
</style>

<title>Mapa da Saúde</title>
{% endblock %}
{% block body %}
<div align="center">
    <div style="text-align: center;">
        <form action="{% url 'site_mapa:mapa' %}" method="POST">
            {% csrf_token %}
            <p>
            <h5 style="margin-top: 10px;">Consultar o mapa por:</h5>
            <div class="form-check-inline">
                <label class="form-check-label" for="escolha">
                    <input type="radio" class="form-check-input" id="escolha" name="escolha" value="endereco_paciente"
                        checked>
                    Endereço dos pacientes
                </label>
            </div>
            <div class="form-check-inline">
                <label class="form-check-label" for="escolha">
                    <input type="radio" class="form-check-input" id="escolha" name="escolha" value="area_ubs">
                    Área das UBS
                </label>
            </div>
            <br>
            <button type="submit" class="btn btn-primary" name="notificacao_valor" id="ButtonModal"
                style="margin-top: 10px;">
                Consultar
            </button>
            </p>
        </form>
    </div>
    <div id="map"></div>
</div>
<script>

    function initMap() {

        //Cria o mapa inicial
        var map = new google.maps.Map(document.getElementById('map'), {
            center: {
                lat: -5.0364390,
                lng: -42.822612
            },
            zoom: 11,
            mapTypeId: 'roadmap'
        });

        {% if escolha_notificacao.0 == "endereco_paciente" %}
        let latitudeNotificacoes = [] // array que recebe a latitude das notificações
        let longitudeNotificacoes = [] // array que recebe a longitude das notificações
        let situacaoNotificacoes = [] // array de inteiros que serve para armazenar a situação atual das notificações
        recebeEndereco(latitudeNotificacoes, longitudeNotificacoes, situacaoNotificacoes)
        for (i = 0; i < latitudeNotificacoes.length; i++) {
            marcaPonto(latitudeNotificacoes[i], longitudeNotificacoes[i], situacaoNotificacoes[i], map)
        }
        {% endif %}

        {% if escolha_notificacao.0 == "area_ubs" %}
        //Cria a janela de informação usada para a área da ubs
        var infowindow = new google.maps.InfoWindow();
        let coordenadasUBS = []
        let situacaoNotificacoes = []
        recebeCoordenadas(coordenadasUBS, situacaoNotificacoes)
        montaPoligonos(coordenadasUBS, situacaoNotificacoes, infowindow, map)
        {% endif %}
    }

    // Função para receber a latitude e longitude dos endereços do banco de dados
    function recebeEndereco(latitudeNotificacoes, longitudeNotificacoes, situacaoNotificacoes) {
        {% for i in notificacoes_mapa %}
        {% if i.situacao_atual == "Suspeito" %}
        situacaoNotificacoes.push(1)
        {% endif %}
        {% if i.situacao_atual == "Confirmado" %}
        situacaoNotificacoes.push(2)
        {% endif %}
        {% if i.situacao_atual == "Curado" %}
        situacaoNotificacoes.push(3)
        {% endif %}
        {% if i.situacao_atual == "Óbito" %}
        situacaoNotificacoes.push(4)
        {% endif %}
        latitudeNotificacoes.push("{{i.paciente.latitude}}")
        longitudeNotificacoes.push("{{i.paciente.longitude}}")
        {% endfor %}
    }

    // Função para marcar os pontos no mapa de acordo com as latitudes e longitudes recuperadas do banco
    function marcaPonto(latitude, longitude, situacao, mapa) {
        pontoLatLng = { lat: parseFloat(latitude), lng: parseFloat(longitude) }
        if (situacao == 1) {
            var marker = new google.maps.Marker({
                map: mapa,
                position: pontoLatLng,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
                }
            });
        }
        if (situacao == 2) {
            var marker = new google.maps.Marker({
                map: mapa,
                position: pontoLatLng,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                }
            });
        }
        if (situacao == 3) {
            var marker = new google.maps.Marker({
                map: mapa,
                position: pontoLatLng,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                }
            });
        }
        if (situacao == 4) {
            var marker = new google.maps.Marker({
                map: mapa,
                position: pontoLatLng,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"
                }
            });
        }
    }

    /*
        // Função que envia uma requisição com o cep para a api viacep e retorna um json com o endereço
        function encontraQuadra(cep, situacao, mapa) {
            var ourRequest = new XMLHttpRequest()
            ourRequest.open('GET', 'https://viacep.com.br/ws/' + cep + '/json/')
            ourRequest.onload = function () {
                if (ourRequest.status >= 200 && ourRequest.status < 400) {
                    var ourData = JSON.parse(ourRequest.responseText)
                    marcaMapaGeocode(ourData.bairro + " " + ourData.logradouro + " " + ourData.complemento, situacao, mapa)
                } else {
                    window.alert("Conexão com o servidor feita com sucesso, porém ele retornou um erro")
                }
            }
            ourRequest.onerror = function () {
                window.alert("Um erro ocorreu")
            }
            ourRequest.send()
        }
    
        // Função que usa a geocoding api da google para colocar um marcador no endereço indicado
        function marcaMapaGeocode(address, situacao, mapa) {
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': address }, function (results, status) {
                if (status === 'OK') {
                    if (situacao == 1) {
                        var marker = new google.maps.Marker({
                            map: mapa,
                            position: results[0].geometry.location,
                            icon: {
                                url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
                            }
                        });
                    }
                    if (situacao == 2) {
                        var marker = new google.maps.Marker({
                            map: mapa,
                            position: results[0].geometry.location,
                            icon: {
                                url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                            }
                        });
                    }
                    if (situacao == 3) {
                        var marker = new google.maps.Marker({
                            map: mapa,
                            position: results[0].geometry.location,
                            icon: {
                                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                            }
                        });
                    }
                    if (situacao == 4) {
                        var marker = new google.maps.Marker({
                            map: mapa,
                            position: results[0].geometry.location,
                            icon: {
                                url: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"
                            }
                        });
                    }
                }
                else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }
    */

    // Função para preencher um array com a string das coordenadas vinda do banco e outro array com as situações atuais 
    function recebeCoordenadas(coordenadasNotificacoes, situacaoNotificacoes) {
        // Preenche ambos arrays, coordenadasNotificacoes com as coordenadas e situacaoNotificacoes com a situação atual
        {% for i in notificacoes_mapa %}
        {% if i.situacao_atual == "Suspeito" %}
        situacaoNotificacoes.push(1)
        {% endif %}
        {% if i.situacao_atual == "Confirmado" %}
        situacaoNotificacoes.push(2)
        {% endif %}
        {% if i.situacao_atual == "Curado" %}
        situacaoNotificacoes.push(3)
        {% endif %}
        {% if i.situacao_atual == "Óbito" %}
        situacaoNotificacoes.push(4)
        {% endif %}
        coordenadasNotificacoes.push("{{i.unidade_saude.coordenadas}}")
        {% endfor %}
    }

    // Função que monta um array com longitude e latitude com base numa string com as coordenadas
    function buildCoordinatesArrayFromString(CoordenadasString) {
        var finalData = []; // Array com latitude e longitude 
        var grouped = CoordenadasString.split("                 "); // Cria um array de substrings divididas a partir do espaço usando a função split()

        // Função que é responsável por separar a latitude e a longitude e depois depositar cada instância no array finalData
        grouped.forEach(function (item, i) { // percorre cada elemento do array grouped usando o forEach
            let a = item.trim().split(','); // trim() serve para elimitar os espaços e o split serve para criar um array de substrings divididas a partir da vírgula, separando lat e lng
            // coloca o novo elemento com lgn e lat no array de coordenadas
            finalData.push({
                lng: parseFloat(a[0]),
                lat: parseFloat(a[1])
            });
        });

        // Retorna o array com todas as coordenadas devidamente organizadas
        return finalData;
    }

    // Função para criar e desenhar os poligonos no mapa
    function montaPoligonos(coordenadasNotificacoes, situacaoNotificacoes, infowindow, mapa) {
        let = coordenadasbrutas = [] // array para receber as coordenadas sem variáveis repetidas
        let ubsNotificacoes = [] // array que recebe as coordenadas de todas as UBS do banco
        let suspeito = [] // array para receber a quantidade de casos suspeitos na área de uma UBS
        let confirmado = [] // array para receber a quantidade de casos confirmados na área de uma UBS
        let curado = [] // array para receber a quantidade de casos curados na área de uma UBS
        let obito = [] // array para receber a quantidade de casos de obito na área de uma UBS
        let flag = 0

        {% for g in ubs_mapa %}
        ubsNotificacoes.push("{{g.coordenadas}}")
        {% endfor %}

        for (let i = 0; i < ubsNotificacoes.length; i++) {
            suspeito[i] = 0
            confirmado[i] = 0
            obito[i] = 0
            curado[i] = 0
            coordenadasbrutas[i] = 0
        }

        for (let i = 0; i < coordenadasNotificacoes.length; i++) {
            for (let j = 0; j < ubsNotificacoes.length; j++) {
                if (coordenadasNotificacoes[i] == ubsNotificacoes[j]) {
                    if (situacaoNotificacoes[i] == 1) {
                        suspeito[j]++
                    }
                    if (situacaoNotificacoes[i] == 2) {
                        confirmado[j]++
                    }
                    if (situacaoNotificacoes[i] == 3) {
                        curado[j]++
                    }
                    if (situacaoNotificacoes[i] == 4) {
                        obito[j]++
                    }
                    for (let k = 0; k < coordenadasbrutas.length; k++) {
                        if (coordenadasbrutas[k] == coordenadasNotificacoes[i]) {
                            flag = 1
                        }
                    }
                    if (flag == 0) {
                        coordenadasbrutas[j] = coordenadasNotificacoes[i];
                    }
                    flag = 0
                }
            }
        }

        // loop para construir o array com as coordenadas devidamente organizadas
        for (let i in coordenadasbrutas) {
            if (coordenadasbrutas[i] != 0) {
                // Pintar a área da ubs de amarelo, pois existem mais casos suspeitos
                if ((suspeito[i] > confirmado[i]) && (suspeito[i] > curado[i]) && (suspeito[i] > obito[i])) {
                    var ubs_poligono = new google.maps.Polygon({
                        paths: buildCoordinatesArrayFromString(coordenadasbrutas[i]),
                        strokeColor: '#FFFF00',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        fillColor: '#FFFF00',
                        fillOpacity: 0.35
                    });
                }
                // Pintar a área da ubs de vermelho, pois existem mais casos confirmados
                if ((confirmado[i] > suspeito[i]) && (confirmado[i] > curado[i]) && (confirmado[i] > obito[i])) {
                    var ubs_poligono = new google.maps.Polygon({
                        paths: buildCoordinatesArrayFromString(coordenadasbrutas[i]),
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35
                    });
                }
                // Pintar a área da ubs de azul, pois existem mais casos curados
                if ((curado[i] > suspeito[i]) && (curado[i] > confirmado[i]) && (curado[i] > obito[i])) {
                    var ubs_poligono = new google.maps.Polygon({
                        paths: buildCoordinatesArrayFromString(coordenadasbrutas[i]),
                        strokeColor: '#0000FF',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        fillColor: '#0000FF',
                        fillOpacity: 0.35
                    });
                }
                // Pintar a área da ubs de roxo, pois existem mais casos de óbito
                if ((obito[i] > suspeito[i]) && (obito[i] > confirmado[i]) && (obito[i] > curado[i])) {
                    var ubs_poligono = new google.maps.Polygon({
                        paths: buildCoordinatesArrayFromString(coordenadasbrutas[i]),
                        strokeColor: '#800080',
                        strokeOpacity: 0.8,
                        strokeWeight: 3,
                        fillColor: '#800080',
                        fillOpacity: 0.35
                    });
                }
                ubs_poligono.setMap(mapa);
                ubs_poligono.addListener('click', function (event) {
                    var contentString = "Suspeitos: " + String(suspeito[i]) + "<br>" + "Confirmados: " + String(confirmado[i]) + "<br>" +
                        "Curados:" + String(curado[i]) + "<br>" + "Óbitos: " + String(obito[i]);
                    infowindow.setContent(contentString);
                    infowindow.setPosition(event.latLng);
                    infowindow.open(mapa);
                });
            }
        }
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{google_api_key}}&callback=initMap" async defer></script>
{% endblock %}